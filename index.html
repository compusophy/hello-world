<!DOCTYPE html>
<html>
<head>
    <title>world-world editor</title>
    
    <!-- Farcaster Mini App Meta Tags -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://raw.githubusercontent.com/compusophy/world-world/main/images/og-image1000.png","button":{"title":"ðŸŒ Open Editor","action":{"type":"launch_frame","name":"world-world","url":"https://world-world.vercel.app/","splashImageUrl":"https://world-world.vercel.app/img","splashBackgroundColor":"#111111"}}}' />

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        button { cursor: pointer; padding: 5px 10px; }
        textarea { width: 100%; box-sizing: border-box; }
        .section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    </style>
</head>
<body>
    <h1>world-world2</h1>

    <div class="section">
        <h3>1. Connect</h3>
        <form hx-post="/auth" hx-target="#status" hx-swap="innerHTML">
            <input type="password" name="token" placeholder="github token">
            <button type="submit">connect</button>
            <button type="button" hx-post="/test-token" hx-target="#status" hx-swap="innerHTML">test token</button>
        </form>
    </div>

    <div class="section">
        <h3>2. Edit Files</h3>
        <div id="file-browser">
            <button hx-get="/files" hx-target="#file-list" hx-swap="innerHTML">load repository files</button>
            <div id="file-list"></div>
        </div>

        <div id="editor-section" style="display:none; margin-top: 20px;">
            <h4 id="current-file" style="margin: 5px 0;">Editing: </h4>
            <form hx-post="/commit" hx-target="#status" hx-swap="innerHTML">
                <input type="hidden" name="filePath" id="current-file-path">
                <input type="hidden" name="sha" id="current-file-sha">
                <textarea name="content" id="file-content" rows="20"></textarea>
                <br>
                <button type="submit">commit change</button>
            </form>
        </div>
    </div>

    <div class="section">
        <h3>3. Create & Merge PRs</h3>
        <form hx-post="/create-pr" hx-target="#status" hx-swap="innerHTML">
            <input type="text" name="title" placeholder="pr title" style="width: 100%; margin-bottom: 5px;">
            <br>
            <textarea name="body" placeholder="pr description" rows="3"></textarea>
            <br>
            <input type="hidden" name="content" value="">
            <input type="hidden" name="filePath" value="">
            <button type="submit" onclick="
                this.form.content.value = document.getElementById('file-content').value;
                this.form.filePath.value = document.getElementById('current-file-path').value;
            ">create pr</button>
        </form>

        <div id="prs-section" style="margin-top: 20px;">
            <button hx-get="/prs" hx-target="#prs-list" hx-swap="innerHTML">load prs</button>
            <div id="prs-list"></div>
        </div>
    </div>

    <div class="section">
        <h3>4. Generate & Upload OG Image</h3>
        <p style="color: #666; font-size: 0.9em;">This creates a real image file in your repo's <code>/images</code> folder.</p>
        
        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <strong>Design:</strong><br>
            <input type="text" id="img-text" placeholder="Title Text" value="world-world" oninput="drawPreview()" style="width: 45%; margin-right: 5%;">
            <input type="text" id="img-subtext" placeholder="Subtitle Text" value="Edit GitHub repos on the go" oninput="drawPreview()" style="width: 45%;">
            <br><br>
            
            <!-- Canvas Preview -->
            <canvas id="previewCanvas" width="600" height="400" style="border:1px solid #ccc; width: 300px; height: 200px; background: #fff;"></canvas>
            
            <br><br>
            <strong>Save:</strong><br>
            <input type="text" id="img-filename" placeholder="image-name.png" value="og-image.png">
            <button onclick="uploadImage()" id="upload-btn" style="background: #000; color: #fff; border: none; padding: 8px 15px;">Upload Image to GitHub</button>
            
            <div id="upload-status" style="margin-top: 10px; word-break: break-all;"></div>
        </div>
    </div>

    <div id="status" style="position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 10px; border-radius: 5px; max-width: 300px; display: none;"></div>

    <script>
        // Status monitor to show the fixed div when content changes
        const statusDiv = document.getElementById('status');
        const observer = new MutationObserver((mutations) => {
            if (statusDiv.innerHTML.trim() !== "") {
                statusDiv.style.display = 'block';
                setTimeout(() => { statusDiv.style.display = 'none'; statusDiv.innerHTML = ''; }, 5000);
            }
        });
        observer.observe(statusDiv, { childList: true });

        // File Loader
        async function loadFile(filePath) {
            try {
                const response = await fetch(`/file/${encodeURIComponent(filePath)}`);
                const data = await response.json();

                if (data.error) {
                    statusDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                    return;
                }

                // Show editor section
                document.getElementById('editor-section').style.display = 'block';

                // Set file info
                document.getElementById('current-file').textContent = `Editing: ${filePath}`;
                document.getElementById('current-file-path').value = filePath;
                document.getElementById('current-file-sha').value = data.sha;
                document.getElementById('file-content').value = data.content;

                statusDiv.innerHTML = `<p>Loaded ${filePath}</p>`;

            } catch (error) {
                statusDiv.innerHTML = `<p>Error loading file: ${error.message}</p>`;
            }
        }

        // --- Image Generation & Upload Logic ---
        
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        
        function drawPreview() {
            const text = document.getElementById('img-text').value;
            const subtext = document.getElementById('img-subtext').value;

            // Background Gradient
            const gradient = ctx.createLinearGradient(0, 0, 600, 400);
            gradient.addColorStop(0, "#111111");
            gradient.addColorStop(1, "#333333");
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 600, 400);

            // Main Text
            ctx.fillStyle = "#00ffaa";
            ctx.font = "bold 48px Arial";
            ctx.textAlign = "center";
            ctx.fillText(text, 300, 180);

            // Subtext
            ctx.fillStyle = "#888888";
            ctx.font = "24px Arial";
            ctx.fillText(subtext, 300, 240);
        }

        async function uploadImage() {
            const btn = document.getElementById('upload-btn');
            const uploadStatus = document.getElementById('upload-status');
            const filename = document.getElementById('img-filename').value || `img-${Date.now()}.png`;
            
            btn.disabled = true;
            btn.textContent = "Uploading...";
            uploadStatus.innerHTML = "Processing...";

            try {
                // Get Base64 from Canvas (remove header)
                const dataUrl = canvas.toDataURL('image/png');
                const base64Content = dataUrl.split(',')[1];

                // Send to Backend
                const response = await fetch('/upload-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: base64Content,
                        filename: filename
                    })
                });

                const data = await response.json();

                if (data.error) {
                    uploadStatus.innerHTML = `<span style="color:red">Error: ${data.error}</span>`;
                } else {
                    uploadStatus.innerHTML = `
                        <div style="background: #e6fffa; padding: 10px; border: 1px solid #00ffaa; border-radius: 4px; margin-top: 10px;">
                            <p style="margin:0; color:green; font-weight:bold;">Success!</p>
                            <p style="margin:5px 0;">Use this URL for Farcaster:</p>
                            <input type="text" value="${data.url}" style="width:100%; padding:5px;" readonly onclick="this.select()">
                        </div>
                    `;
                }

            } catch (err) {
                uploadStatus.innerHTML = `<span style="color:red">Error: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = "Upload Image to GitHub";
            }
        }

        // Initial draw
        drawPreview();
    </script>
    
    <!-- Farcaster Mini App SDK -->
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'
        // Notify the Farcaster client that the Mini App is ready
        await sdk.actions.ready()
    </script>
</body>
</html>
